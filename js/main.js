"use strict";function showPlayer(){linksEl.classList.add("hidden"),playerEl.classList.remove("hidden")}function initCanvas(){canvas=document.querySelector(".player__canvas"),canvasStartState(),canvas.addEventListener("click",function(t){var e=t.pageX-t.target.offsetLeft,a=t.pageY-t.target.offsetTop;controlElements.some(function(t){e<t.right&&e>t.left&&a>t.top&&a<t.bottom&&("pause"==t.type?(isSubtitleShown?stopSubTimeout():(video.pause(),stopDrawLoop(),drawCenterPlayButton(canvasControlsColor)),audio.pause(),controlElements=[],createStartElement()):(isSubtitleShown?startSubTimeout():video.play(),audio.play(),createPauseElement()))})},!1)}function createStartElement(){controlElements=[{type:"start",top:0,left:0,right:canvas.width,bottom:canvas.height}]}function createPauseElement(){controlElements=[{type:"pause",top:0,left:0,right:canvas.width,bottom:canvas.height}]}function canvasStartState(){video.width=canvas.width=video.offsetWidth,video.height=canvas.height=video.offsetHeight;canvas.getContext("2d");drawBackground(canvasBgColor),drawCenterPlayButton(canvasControlsColor)}function grayAndGrain(t){for(var e=t.data,a=void 0,n=0;n<e.length;n+=4){a=Math.random()+1;var i=e[n],o=e[n+1],s=e[n+2],r=.2126*i+.7152*o+.0722*s;e[n]=e[n+1]=e[n+2]=r*a}return t}function drawBackground(t){ctx.fillStyle=t,ctx.fillRect(0,0,canvas.width,canvas.height)}function drawCenterPlayButton(t){ctx.fillStyle=""+t;var e={width:35,height:50};e.points={top:{x:(canvas.width-e.width)/2,y:(canvas.height-e.height)/2},bottom:{x:(canvas.width-e.width)/2,y:(canvas.height+e.height)/2},right:{x:(canvas.width+e.width)/2,y:canvas.height/2}},controlElements.push({type:"start",top:e.points.top.y,left:e.points.top.x,bottom:e.points.bottom.y,right:e.points.right.x}),ctx.beginPath(),ctx.moveTo(e.points.top.x,e.points.top.y),ctx.lineTo(e.points.bottom.x,e.points.bottom.y),ctx.lineTo(e.points.right.x,e.points.right.y),ctx.fill()}function drawSkratches(){var t=Math.random()*(.8-.2);ctx.strokeStyle="rgba(255, 255, 255, "+t+")";var e=Math.floor(101*Math.random());if(e-=98,e>0)for(var a=0;a<e;a++)skratch()}function skratch(){ctx.beginPath();var t={x:Math.floor(Math.random()*(canvas.width-1)),y:Math.floor(Math.random()*(canvas.height-1))},e={x:t.x,y:Math.floor(Math.random()*(canvas.height-t.y))};ctx.moveTo(t.x,t.y),ctx.lineTo(e.x,e.y),ctx.stroke()}function startDrawLoop(){loopId||isSubtitleShown?"undefined"!=typeof subtitles[subtitleIndex]&&(subTimeout=setTimeout(hideSub,subtitles[subtitleIndex].timeLength/2)):loopId=setInterval(drawLoop,fps)}function stopDrawLoop(){loopId&&(clearInterval(loopId),loopId=void 0)}function drawLoop(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(video,0,0,video.width,video.height);var t=ctx.getImageData(0,0,canvas.width,canvas.height),e=grayAndGrain(t);ctx.putImageData(e,0,0),drawSkratches()}function _onInputChange(t){var e=new FileReader;switch(!0){case t.target.classList.contains("links-form__video"):e.readAsDataURL(t.target.files[0]),e.addEventListener("load",function(t){createVideo(e.result)});break;case t.target.classList.contains("links-form__sub"):e.readAsText(t.target.files[0]),e.addEventListener("load",function(t){subtitles=parseSrt(e.result)});break;case t.target.classList.contains("links-form__audio"):e.readAsDataURL(t.target.files[0]),e.addEventListener("load",function(t){createAudio(e.result)})}}function checkInputs(t){t.preventDefault();var e=document.querySelectorAll(".links-form__input"),a=!0;e.forEach(function(t){""===t.value&&(a=!1)}),a&&(showPlayer(),initCanvas())}function createVideo(t){video=document.createElement("video"),video.src=t,video.defaultMuted=!0,video.classList.add("player__video"),video.width=videoWidth,video.height=videoHeight,document.querySelector(".hidden-elements").appendChild(video),video.addEventListener("play",startDrawLoop,!1),video.addEventListener("pause",stopDrawLoop,!1),video.addEventListener("timeupdate",function(t){var e=(1e3*t.target.currentTime).toFixed();"undefined"!=typeof subtitles[subtitleIndex]&&e>=subtitles[subtitleIndex].endTime&&(isSubtitleShown||(showSub(subtitles[subtitleIndex]),startSubTimeout()))}),video.addEventListener("ended",function(t){audio.pause(),stopDrawLoop()},!1)}function createAudio(t){audio=document.createElement("audio"),audio.src=t,audio.autoplay=!1,audio.classList.add("player__audio"),document.querySelector(".hidden-elements").appendChild(audio)}function parseSrt(t){var e={sec:1e3,min:60,hr:60},a=t.split("\n\n"),n=a.map(function(t){var a={},n=t.split("\n");a.number=parseInt(n[0]);var i=n[1].split(" --> "),o=i[0].split(":"),s=parseInt(o[2].split(",").join("")),r=parseInt(o[1])*e.min*e.sec,c=parseInt(o[0])*e.hr*e.min*e.sec;o=s+r+c,a.startTime=o;var d=i[1].split(":"),l=parseInt(d[2].split(",").join("")),u=parseInt(d[1])*e.min*e.sec,h=parseInt(d[0])*e.hr*e.min*e.sec;return d=l+u+h,a.endTime=d,a.timeLength=d-o,n.splice(0,2),a.content=n,a});return n}function showSub(t){isSubtitleShown=!0,video.pause(),drawSub(t)}function drawSub(t){ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="white",ctx.font=canvasFontSize+"px Oranienbaum, serif";var e=t.content.length*canvasFontSize+(t.content.length-1)*canvasLineHeight,a=(canvas.height-e)/2;t.content.forEach(function(t,e){var n=a+canvasFontSize*e+canvasLineHeight*e,i=.1*canvas.width;ctx.fillText(t,i,n)})}function hideSub(){isSubtitleShown&&(isSubtitleShown=!1,subtitleIndex++,video.play()),clearTimeout(subTimeout),subTimeout=void 0,controlElements=[],createPauseElement()}function stopSubTimeout(){subTimeout&&(clearTimeout(subTimeout),subTimeout=void 0)}function startSubTimeout(){subTimeout=setTimeout(hideSub,subtitles[subtitleIndex].timeLength)}var canvasBgColor="#000",canvasControlsColor="#fff",canvasFontColor="#fff",canvasFontSize=24,canvasLineHeight=12,linksForm=document.querySelector(".links-form"),linksEl=document.querySelector(".links"),playerEl=document.querySelector(".player"),submitEl=document.querySelector(".links-form__submit"),fps=1e3/60,video=void 0,canvas=void 0,audio=void 0;canvas=document.querySelector(".player__canvas");var controlElements=[],reader=new FileReader,srt=void 0,videoWidth=700,videoHeight=400,isSubtitleShown=!1,subtitles=void 0,subTimeout=void 0,subtitleIndex=0,ctx=canvas.getContext("2d"),loopId=void 0;linksForm.addEventListener("change",_onInputChange,!1),submitEl.addEventListener("click",checkInputs,!1);
//# sourceMappingURL=main.js.map
